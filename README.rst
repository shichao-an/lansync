lansync
=======

Sync and backup file between hosts on the LAN over SSH.

How It Works
------------
On an OS X host, ``lansync.sh`` can be used to sync (using `rsync`) files from another host on the LAN.


Setup
-----
On Machine B, where ``lansync.sh`` resides, you want to routinely back up files from Machine A on the LAN with B, whose IP address may change. The OS X host where ``lansync.sh`` is invoked, can be configured to enable DNS server or not (simply use /etc/hosts).

Set up DNS server (optional)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*named* and *rndc* utility are installed by default on OS X 10.8.

1. Use ``rndc-confgen`` to generate configuration and secret key::

    $ sudo bash -c "rndc-confgen -b 256 > /etc/rndc.conf"
    $ sudo bash -c " head -n5 /etc/rndc.conf | tail -n4 > /etc/rndc.key"

2. Edit /etc/named.conf and /etc/rndc.conf to ensure the port number are the same

3. Start named server, run ``rndc status`` to check whether it is started::

    $ launchctl load -w /System/Library/LaunchDaemons/org.isc.named.plist
    $ launchctl start org.isc.named
    $ rndc status

4. Create a zone file for the target machine (Machine A in this case)::

    $ cd ~/Documents/
    $ mkdir named
    $ cd named
    $ vi machine-a.zone

Copy the following text in to machine-a.zone, the IP address 192.168.0.120 is irrelevant at this time::

    $TTL 86400
    $ORIGIN machine-a.
     
    @       IN      SOA     @ root (
                            2013091701      ; serial number YYMMDDNN
                            28800           ; Refresh
                            7200            ; Retry
                            864000          ; Expire
                            86400           ; Min TTL
                )
            IN      NS      @
            IN      A       192.168.0.120   ; lan-sync

5. Create symbolic link at /var/named/machine-a.zone (/private/var/named/machine-a.zone)::

    $ ln -s /Users/yourname/Documents/named/machine-a.zone /private/var/named/machine-a.zone

6. Edit /etc/named.conf, insert the following lines after the existing zone configurations::

    zone "machine-a" IN {
            type master;
            file "machine-a.zone";
            allow-update { none; };
    };

7 Edit /etc/resolv.conf, replace existing nameserver with 127.0.0.1. This file should look like this::

    #
    # This file is automatically generated.
    #
    nameserver 127.0.0.1

Download the script and set the variables
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
::

    user_home="/Users/yourname"
    # Remote hostname (LAN) and MAC address
    hostname="machine-a"
    # User name on the remote host
    username="yourname"
    mac_address="11:11:11:11:11:11"

Setup SSH login
~~~~~~~~~~~~~~~
Setup public/private key pair on Machine A and B. Make sure Machine A's port 22 is open. Set the SSH config file for Machine B to make something like this::

    Host machine-b
        IdentityFile ~/.ssh/machine-b-sshkey
        User yourname

Usage
-----
::

    $ ./lansync.sh hosts|dns <remote_src_path> <local_dest_path>

Example
-------
::

    $ ./lansync.sh dns /Users/john/homework /Users/john/backup

This syncs the directory /Users/john/homework into /Users/john/backup/homework.

Diagnostics
-----------
If "The host may be down or not accessible at this time." message appears and the remote machine is actually up. If you know the IP address of the remote machine on the LAN, try the following command::

    $ ./lansync.sh test <ip address>

or::

    $ ping <ip address>

Then execute the script again. The local ARP table should be updated.
